# 02. Дискова подсистема

## Домашнее задание

>Работа с mdadm
>
>Цель: 
>
>* добавить в Vagrantfile еще дисков
>* сломать/починить raid
>* собрать R0/R5/R10 на выбор
>* прописать собранный рейд в конф, чтобы рейд собирался при загрузке
>* создать GPT раздел и 5 партиций
>
> В качестве проверки принимаются - измененный Vagrantfile, скрипт для создания рейда
>
> `*` Доп. задание - Vagrantfile, который сразу собирает систему с подключенным рейдом.
>
> `**` Перенести работающую систему с одним диском на RAID1. Даунтайм на загрузку с нового диска предполагается. В качестве проверки принимается вывод команды lsblk до и после и описание хода решения (можно аоспользоваться утилитой Script).

## Выполнение Домашнего задания

###  1. Обновленный Vagrantfile

`Vagrantfile` настраивает виртуальную машину с использованием образа `generic/centos9s`, добавляет четыре дополнительных SATA диска, и запускает provisioning скрипт для настройки RAID и разделов.

**Объяснение Изменений**:

**1. Абсолютные Пути и Директория `disks`:**

* Все диски хранятся в поддиректории `disks` относительно `Vagrantfile`.

* Создается абсолютный путь для каждого диска с помощью `File.expand_path`.

* Если директория `disks` не существует, она создается автоматически.

**2. Добавление Контроллера `SATA`:**

* Контроллер `SATA Controller` добавляется один раз для каждой машины, независимо от создания новых дисков.
 
* Используется имя `"SATA Controller"` для консистентности.

**3. Цикл для Добавления Дисков:**

* Используется цикл `each` для перебора списка дисков и присоединения каждого из них к виртуальной машине.
  
* Проверяется существование диска перед его созданием, предотвращая ошибку `VERR_ALREADY_EXISTS`.

**4. Параметры `RAID`:**

* Добавлены параметры `raid_level` и `raid_devices` для гибкой настройки RAID массива.

### 2. Provisioning Скрипт (`provision.sh`)

Этот скрипт выполняется внутри виртуальной машины для настройки RAID, создания GPT разделов и файловых систем.

**Объяснение Скрипта:**

**1. Переменные:**

* `RAID_LEVEL` и `RAID_DEVICES` настраиваются через переменные окружения или принимают значения по умолчанию.

**2. Установка Пакетов:**

* Устанавливает необходимые пакеты для работы с RAID и разделами.

**3. Настройка RAID:**

* В зависимости от уровня `RAID`, формирует параметры для создания массива.

* Собирает список устройств для `RAID` массива.

* Создает `RAID` массив с заданными параметрами.

**4. Сохранение конфигурации mdadm:**

* Сохраняет конфигурацию RAID массива в /etc/mdadm.conf.

* Обновляет initramfs для поддержки RAID при загрузке.

**5. Создание GPT раздела и партиций**

* Создает GPT раздел на созданном RAID массиве (/dev/md0)

* Создает 4 партиции на указанном RAID массиве (/dev/md0)

**6. Файловая Система и Монтирование:**

* Форматирует RAID массив в ext4.
  
* Создает точки монтирования и монтирует партиции.

* Добавляет записи в /etc/fstab для автоматического монтирования при загрузке.

**7. Проверка:**

* Выводит состояние дисков и RAID массива с помощью lsblk.
